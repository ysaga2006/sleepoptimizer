<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>睡眠最適化ツール</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    };
  </script>
</head>
<body class="bg-white text-black dark:bg-gray-900 dark:text-white transition-colors">
  <div class="max-w-xl mx-auto p-4 space-y-6 bg-white dark:bg-gray-800 rounded-lg shadow">
    <h1 class="text-2xl font-bold text-center">睡眠最適化ツール</h1>

    <div id="sleep-inputs" class="space-y-4"></div>

    <div class="space-y-2">
      <label class="block font-medium">普段の起床予定時刻</label>
      <input type="time" id="wakeTime" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" />
    </div>

    <div class="space-y-2">
      <label class="block font-medium">（オプション）〇日後に起きたい時間</label>
      <input type="number" min="1" max="7" id="daysUntilTarget" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" placeholder="何日後" />
      <input type="time" id="targetWakeTime" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" placeholder="起床時刻" />
    </div>

    <button onclick="handleCalculate()" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-600">最適な就寝時刻を計算</button>

    <div id="results" class="space-y-4"></div>

    <div class="text-center pt-6">
      <button onclick="document.body.classList.toggle('dark')" class="text-sm underline">ダークモード切り替え</button>
    </div>
  </div>

  <script>
    const sleepData = Array(7).fill({ start: "00:00", end: "07:00" });

    function parseTime(timeStr) {
      const [h, m] = timeStr.split(":").map(Number);
      return h + m / 60;
    }

    function formatTime(decimalHours) {
      let h = Math.floor(decimalHours) % 24;
      let m = Math.round((decimalHours % 1) * 60);
      if (m < 0) m += 60, h--;
      if (h < 0) h += 24;
      return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}`;
    }

    function handleCalculate() {
      const wakeTime = document.getElementById("wakeTime").value || "07:00";
      const targetWakeTime = document.getElementById("targetWakeTime").value;
      const daysUntilTarget = parseInt(document.getElementById("daysUntilTarget").value);

      const wakeDecimal = parseTime(wakeTime);
      const durations = sleepData.map(({ start, end }) => {
        const startH = parseTime(start);
        const endH = parseTime(end);
        return endH > startH ? endH - startH : 24 - startH + endH;
      });

      const avgSleep = durations.reduce((a, b) => a + b, 0) / durations.length;
      const sleepDebt = Math.max(0, 7.5 - avgSleep);
      const baseTargetSleep = 7.5 + sleepDebt * 0.6;

      let plans = [];

      if (targetWakeTime && daysUntilTarget) {
        const today = parseTime(wakeTime);
        const target = parseTime(targetWakeTime);
        const step = (today - target) / daysUntilTarget;

        for (let d = 1; d <= daysUntilTarget; d++) {
          const dayWake = today - step * d;
          const bedtime = dayWake - baseTargetSleep;
          plans.push({
            day: d,
            label: `${d}日後の計画`,
            bedtime: formatTime(bedtime),
            wake: formatTime(dayWake),
            duration: baseTargetSleep.toFixed(1)
          });
        }
      } else {
        const targetBedtime = wakeDecimal - baseTargetSleep;

        const cycles = [4.5, 6.0, 7.5, 9.0];
        plans = cycles.map(cycle => {
          const bedtime = wakeDecimal - cycle;
          return {
            label: `周期一致 (${cycle}h)`,
            bedtime: formatTime(bedtime),
            wake: formatTime(wakeDecimal),
            duration: cycle.toFixed(1)
          };
        });

        plans.push({
          label: "睡眠負債調整 + リズム維持",
          bedtime: formatTime(targetBedtime),
          wake: formatTime(wakeDecimal),
          duration: baseTargetSleep.toFixed(1)
        });
      }

      const resultsEl = document.getElementById("results");
      resultsEl.innerHTML = `<h2 class='text-xl font-semibold text-center'>おすすめの就寝計画</h2>` +
        plans.map(r => `
          <div class='border rounded p-4 bg-gray-100 dark:bg-gray-700'>
            <div class='font-bold text-lg'>${r.bedtime} → ${r.wake}</div>
            <div class='text-sm text-gray-600 dark:text-gray-300'>${r.label}（${r.duration} 時間）</div>
          </div>`).join("");
    }

    const container = document.getElementById("sleep-inputs");
    sleepData.forEach((entry, i) => {
      const div = document.createElement("div");
      div.className = "flex flex-col sm:flex-row sm:items-center sm:gap-2";
      div.innerHTML = `
        <span class="w-full sm:w-16 font-medium">${i + 1}日目</span>
        <div class="flex gap-2 mt-1 sm:mt-0">
          <input type="time" value="${entry.start}" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" id="start-${i}" />
          <span class="self-center">〜</span>
          <input type="time" value="${entry.end}" class="w-full p-2 rounded border dark:bg-gray-700 dark:border-gray-600" id="end-${i}" />
        </div>
      `;
      container.appendChild(div);
    });

    for (let i = 0; i < 7; i++) {
      document.getElementById(`start-${i}`).addEventListener("change", e => sleepData[i].start = e.target.value);
      document.getElementById(`end-${i}`).addEventListener("change", e => sleepData[i].end = e.target.value);
    }
  </script>
</body>
</html>
