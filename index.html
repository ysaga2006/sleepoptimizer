<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>睡眠スケジュール最適化</title>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: sans-serif;
      padding: 20px;
    }

    h1 {
  text-align: center;
  font-size: 2rem;
  white-space: nowrap; /* 改行を防ぐ */
}

@media (max-width: 600px) {
  h1 {
    font-size: 1.5rem;
  }
}

    label, input, select {
      display: block;
      width: 100%;
      margin-top: 10px;
    }

    input, select, button {
      padding: 10px;
      background-color: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #444;
      border-radius: 5px;
    }

    button {
      margin-top: 20px;
      cursor: pointer;
    }

    #result {
      margin-top: 20px;
      padding: 10px;
      background-color: #1e1e1e;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<h1>睡眠スケジュール最適化</h1>

<form id="sleepForm">
  <div id="dateInputs"></div>

  <label>予定の起床日:</label>
  <input type="date" id="targetDate" />

  <label>予定の起床時刻:</label>
  <input type="time" id="targetTime" />

  <label>理想の睡眠時間（時間）:</label>
 <select id="desiredSleep">
  <option value="4">4 時間</option>
  <option value="4.5">4.5 時間</option>
  <option value="5">5 時間</option>
  <option value="5.5">5.5 時間</option>
  <option value="6">6 時間</option>
  <option value="6.5">6.5 時間</option>
  <option value="7">7 時間</option>
  <option value="7.5">7.5 時間</option>
  <option value="8">8 時間</option>
  <option value="8.5">8.5 時間</option>
  <option value="9">9 時間</option>
  <option value="9.5">9.5 時間</option>
  <option value="10">10 時間</option>
</select>

  <button type="button" onclick="calculateSchedule()">スケジュールを計算</button>
  <button type="button" onclick="saveData()">記録を保存</button>
</form>

<div id="result"></div>

<script>
  const dateInputs = document.getElementById("dateInputs");

  function formatDate(date) {
    return date.toISOString().split("T")[0];
  }

  // 過去7日分の日付入力欄を作成
  function generateInputs() {
    const today = new Date();
    for (let i = 6; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = formatDate(d);
      dateInputs.innerHTML += `
        <label>${dateStr}</label>
        <input type="time" id="bed_${dateStr}" placeholder="就寝時間">
        <input type="time" id="wake_${dateStr}" placeholder="起床時間">
      `;
    }
  }

  generateInputs();

  // ローカルストレージに保存
  function saveData() {
    const sleepData = {};
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = formatDate(date);
      const bed = document.getElementById(`bed_${dateStr}`).value;
      const wake = document.getElementById(`wake_${dateStr}`).value;
      sleepData[dateStr] = { bed, wake };
    }
    localStorage.setItem("sleepRecords", JSON.stringify(sleepData));
    alert("保存しました。");
  }

  function loadData() {
    const saved = JSON.parse(localStorage.getItem("sleepRecords") || "{}");
    for (const date in saved) {
      const bed = saved[date].bed;
      const wake = saved[date].wake;
      const bedInput = document.getElementById(`bed_${date}`);
      const wakeInput = document.getElementById(`wake_${date}`);
      if (bedInput && wakeInput) {
        bedInput.value = bed;
        wakeInput.value = wake;
      }
    }
  }

  loadData();

  function timeToHours(t) {
    if (!t) return null;
    const [h, m] = t.split(":").map(Number);
    return h + m / 60;
  }

  function hoursToTime(h) {
    const hour = Math.floor(h) % 24;
    const minute = Math.round((h % 1) * 60);
    return `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}`;
  }

  function calculateSchedule() {
    const records = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const dateStr = formatDate(date);
      const bed = timeToHours(document.getElementById(`bed_${dateStr}`).value);
      const wake = timeToHours(document.getElementById(`wake_${dateStr}`).value);
      if (bed != null && wake != null) {
        const duration = wake > bed ? wake - bed : 24 - bed + wake;
        records.push({ date: dateStr, duration, wake });
      }
    }

    const avgSleep = records.length
      ? records.reduce((sum, r) => sum + r.duration, 0) / records.length
      : 7;

    const desiredSleep = parseFloat(document.getElementById("desiredSleep").value) || avgSleep;

    const targetDate = new Date(document.getElementById("targetDate").value);
    const [targetHour, targetMin] = document.getElementById("targetTime").value.split(":").map(Number);
    targetDate.setHours(targetHour, targetMin, 0, 0);

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const daysUntil = Math.round((targetDate - today) / (1000 * 60 * 60 * 24));

    if (daysUntil < 1) {
      alert("起床予定は明日以降を選んでください");
      return;
    }

    let currentWake = targetHour + targetMin / 60;
    const schedule = [];

    for (let i = daysUntil - 1; i >= 0; i--) {
      const date = new Date();
      date.setDate(today.getDate() + i);

      const targetSleep = desiredSleep;
      const proposedWake = Math.min(currentWake + 1, 24); // 極端に早くしない
      const wake = Math.max(proposedWake - 1, 4); // 最小4時起床
      const bedtime = (wake - targetSleep + 24) % 24;

      schedule.unshift({
        date: formatDate(date),
        wake: hoursToTime(wake),
        bed: hoursToTime(bedtime),
      });

      currentWake = wake;
    }

    const result = document.getElementById("result");
    result.innerHTML = "<h3>おすすめスケジュール:</h3>";
    schedule.forEach((d) => {
      result.innerHTML += `<p>${d.date}：${d.bed} 就寝 → ${d.wake} 起床</p>`;
    });
  }
</script>

</body>
</html>
